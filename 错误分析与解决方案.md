# Next.js ç‰ˆæœ¬æ£€æµ‹é”™è¯¯åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## é”™è¯¯ä¿¡æ¯
```
Error: No Next.js version detected. Make sure your package.json has "next" in either "dependencies" or "devDependencies". Also check your Root Directory setting matches the directory of your package.json file.
```

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 
1. **é¡¹ç›®ç±»å‹æ··æ·†**: å½“å‰é¡¹ç›®æ˜¯åŸºäº NestJS çš„ Node.js åº”ç”¨ï¼Œè€Œä¸æ˜¯ Next.js åº”ç”¨
2. **Vercel é…ç½®é—®é¢˜**: Vercel å¹³å°å¯èƒ½é”™è¯¯åœ°å°†é¡¹ç›®è¯†åˆ«ä¸º Next.js æ¡†æ¶
3. **éƒ¨ç½²è®¾ç½®é”™è¯¯**: åœ¨ Vercel éƒ¨ç½²è®¾ç½®ä¸­å¯èƒ½é€‰æ‹©äº†é”™è¯¯çš„æ¡†æ¶ç±»å‹

### é¡¹ç›®å®é™…æƒ…å†µ
- **å®é™…æ¡†æ¶**: NestJS 10.x (Node.js åç«¯æ¡†æ¶)
- **é¡¹ç›®ç±»å‹**: CORS ä»£ç†æœåŠ¡
- **éƒ¨ç½²æ–¹å¼**: Node.js åº”ç”¨éƒ¨ç½²åˆ° Vercel
- **æ„å»ºäº§ç‰©**: `dist/main.js` (NestJS ç¼–è¯‘åçš„ Node.js åº”ç”¨)

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¿®æ­£ Vercel é¡¹ç›®è®¾ç½® (æ¨è)

1. **ç™»å½• Vercel Dashboard**
   - è®¿é—® [vercel.com](https://vercel.com)
   - è¿›å…¥é¡¹ç›®è®¾ç½®é¡µé¢

2. **ä¿®æ”¹æ¡†æ¶è®¾ç½®**
   ```
   Settings â†’ General â†’ Framework Preset
   å°† "Next.js" æ”¹ä¸º "Other" æˆ– "Node.js"
   ```

3. **ç¡®è®¤æ„å»ºè®¾ç½®**
   ```
   Settings â†’ General â†’ Build & Development Settings
   - Build Command: npm run build
   - Output Directory: dist
   - Install Command: npm install
   ```

### æ–¹æ¡ˆäºŒï¼šæ›´æ–° vercel.json é…ç½®

å½“å‰çš„ `vercel.json` é…ç½®æ˜¯æ­£ç¡®çš„ï¼Œä½†å¯ä»¥æ·»åŠ æ˜ç¡®çš„æ¡†æ¶æŒ‡å®šï¼š

```json
{
  "version": 2,
  "framework": null,
  "builds": [
    {
      "src": "dist/main.js",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "dist/main.js"
    }
  ],
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "installCommand": "npm install"
}
```

### æ–¹æ¡ˆä¸‰ï¼šé‡æ–°éƒ¨ç½²é¡¹ç›®

1. **åˆ é™¤ç°æœ‰ Vercel é¡¹ç›®**
2. **é‡æ–°å¯¼å…¥é¡¹ç›®**
3. **åœ¨å¯¼å…¥æ—¶é€‰æ‹©æ­£ç¡®çš„æ¡†æ¶ç±»å‹**ï¼š
   - Framework Preset: "Other" æˆ– "Node.js"
   - ä¸è¦é€‰æ‹© "Next.js"

## éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥é¡¹ç›®ä¾èµ–
```bash
# ç¡®è®¤è¿™æ˜¯ NestJS é¡¹ç›®
grep -E '"@nestjs' package.json

# ç¡®è®¤æ²¡æœ‰ Next.js ä¾èµ–
grep -E '"next"' package.json
```

### 2. æœ¬åœ°æ„å»ºæµ‹è¯•
```bash
# å®‰è£…ä¾èµ–
npm install

# æ„å»ºé¡¹ç›®
npm run build

# æ£€æŸ¥æ„å»ºäº§ç‰©
ls -la dist/

# æœ¬åœ°è¿è¡Œæµ‹è¯•
npm run start:prod
```

### 3. éƒ¨ç½²åéªŒè¯
```bash
# è®¿é—®æµ‹è¯•ç«¯ç‚¹
curl https://your-app.vercel.app/

# æµ‹è¯•ä»£ç†åŠŸèƒ½
curl "https://your-app.vercel.app/?url=https://api.github.com/users/octocat"
```

## é¢„é˜²æªæ–½

### 1. æ˜ç¡®é¡¹ç›®æ–‡æ¡£
- åœ¨ README.md ä¸­æ˜ç¡®è¯´æ˜è¿™æ˜¯ NestJS é¡¹ç›®
- æ·»åŠ æ­£ç¡®çš„éƒ¨ç½²è¯´æ˜

### 2. è§„èŒƒå‘½å
- è€ƒè™‘å°†é¡¹ç›®æ–‡ä»¶å¤¹åä» `next` æ”¹ä¸º `nestjs-cors-proxy`
- é¿å…å› æ–‡ä»¶å¤¹åç§°å¯¼è‡´çš„æ¡†æ¶è¯†åˆ«æ··æ·†

### 3. å®Œå–„é…ç½®
- åœ¨ `package.json` ä¸­æ·»åŠ æ˜ç¡®çš„é¡¹ç›®æè¿°
- åœ¨ `vercel.json` ä¸­æ˜ç¡®æŒ‡å®š `"framework": null`

## æ€»ç»“

è¿™ä¸ªé”™è¯¯æ˜¯ç”±äº Vercel å¹³å°é”™è¯¯åœ°å°† NestJS é¡¹ç›®è¯†åˆ«ä¸º Next.js é¡¹ç›®å¯¼è‡´çš„ã€‚é€šè¿‡ä¿®æ­£ Vercel é¡¹ç›®è®¾ç½®ä¸­çš„æ¡†æ¶ç±»å‹ï¼Œæˆ–è€…åœ¨ `vercel.json` ä¸­æ˜ç¡®æŒ‡å®šæ¡†æ¶ä¸º nullï¼Œå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å…³é”®ç‚¹ï¼š
- âœ… é¡¹ç›®æœ¬èº«é…ç½®æ­£ç¡®ï¼ˆNestJS + Node.jsï¼‰
- âŒ Vercel æ¡†æ¶è¯†åˆ«é”™è¯¯ï¼ˆè¯¯è®¤ä¸º Next.jsï¼‰
- ğŸ”§ è§£å†³æ–¹æ¡ˆï¼šä¿®æ­£ Vercel éƒ¨ç½²è®¾ç½®

## ç›¸å…³é”™è¯¯è§£å†³æ–¹æ¡ˆ

### Verceléƒ¨ç½²é…ç½®å†²çªé”™è¯¯

#### é”™è¯¯æè¿°
```
If `rewrites`, `redirects`, `headers`, `cleanUrls` or `trailingSlash` are used, then `routes` cannot be present.
```

#### é”™è¯¯åŸå› 
Vercelé…ç½®æ–‡ä»¶ä¸­åŒæ—¶ä½¿ç”¨äº† `routes` å’Œ `rewrites` é…ç½®é¡¹ï¼Œè¿™åœ¨Vercelå¹³å°ä¸­æ˜¯ä¸è¢«å…è®¸çš„ã€‚Vercelè¦æ±‚åœ¨ä½¿ç”¨æ–°çš„é…ç½®é¡¹ï¼ˆå¦‚ `rewrites`ã€`redirects`ã€`headers` ç­‰ï¼‰æ—¶ï¼Œä¸èƒ½åŒæ—¶ä½¿ç”¨æ—§çš„ `routes` é…ç½®ã€‚

#### è§£å†³æ–¹æ¡ˆ
1. **ç§»é™¤ `routes` é…ç½®**ï¼šä» `vercel.json` ä¸­åˆ é™¤ `routes` é…ç½®é¡¹
2. **ä½¿ç”¨ `rewrites` æ›¿ä»£**ï¼šé€šè¿‡ `rewrites` é…ç½®æ¥å¤„ç†è·¯ç”±éœ€æ±‚

#### ä¿®å¤å‰çš„é…ç½®
```json
{
  "routes": [
    {
      "src": "/(.*)",
      "dest": "dist/main.js"
    }
  ],
  "rewrites": [
    {
      "source": "/",
      "destination": "/index.html"
    }
  ]
}
```

#### ä¿®å¤åçš„é…ç½®
```json
{
  "rewrites": [
    {
      "source": "/",
      "destination": "/index.html"
    },
    {
      "source": "/api/(.*)",
      "destination": "/dist/main.js"
    }
  ]
}
```

#### é…ç½®è¯´æ˜
- **æ ¹è·¯å¾„é‡å†™**ï¼š`"/"` é‡å†™åˆ° `/index.html`ï¼Œç”¨äºæ˜¾ç¤ºæµ‹è¯•é¡µé¢
- **APIè·¯ç”±é‡å†™**ï¼š`"/api/(.*)"`é‡å†™åˆ° `/dist/main.js`ï¼Œå¤„ç†æ‰€æœ‰APIè¯·æ±‚
- **ç§»é™¤å†²çª**ï¼šå®Œå…¨ç§»é™¤ `routes` é…ç½®ï¼Œé¿å…ä¸ `rewrites` å†²çª

#### éªŒè¯æ–¹æ³•
1. é‡æ–°éƒ¨ç½²åˆ°Vercel
2. æµ‹è¯•APIç«¯ç‚¹ï¼š`https://your-domain.vercel.app/api/proxy?url=https://httpbin.org/get`
3. æµ‹è¯•æ ¹è·¯å¾„ï¼š`https://your-domain.vercel.app/`

#### ç›¸å…³æ–‡æ¡£
- [Vercel Rewrites Documentation](https://vercel.com/docs/concepts/projects/project-configuration#rewrites)
- [Vercel Routes vs Rewrites](https://vercel.com/docs/concepts/projects/project-configuration#routes-vs-rewrites)

### Vercel buildsä¸functionsé…ç½®å†²çªé”™è¯¯

#### é”™è¯¯æè¿°
```
The `functions` property cannot be used in conjunction with the `builds` property. Please remove one of them.
```

#### é”™è¯¯åŸå› 
Vercelé…ç½®æ–‡ä»¶ä¸­åŒæ—¶ä½¿ç”¨äº† `builds` å’Œ `functions` é…ç½®é¡¹ã€‚åœ¨Vercelçš„æ–°ç‰ˆæœ¬ä¸­ï¼Œ`functions` æ˜¯æ›´ç°ä»£çš„é…ç½®æ–¹å¼ï¼Œä¸èƒ½ä¸æ—§çš„ `builds` é…ç½®åŒæ—¶ä½¿ç”¨ã€‚

#### è§£å†³æ–¹æ¡ˆ
1. **ç§»é™¤ `builds` é…ç½®**ï¼šåˆ é™¤æ—§çš„ `builds` é…ç½®é¡¹
2. **ä¿ç•™å¹¶ä¼˜åŒ– `functions` é…ç½®**ï¼šä½¿ç”¨ç°ä»£çš„ `functions` é…ç½®ï¼Œå¹¶æ·»åŠ è¿è¡Œæ—¶è§„èŒƒ

#### ä¿®å¤å‰çš„é…ç½®
```json
{
  "builds": [
    {
      "src": "dist/main.js",
      "use": "@vercel/node"
    }
  ],
  "functions": {
    "dist/main.js": {
      "maxDuration": 30,
      "memory": 1024
    }
  }
}
```

#### ä¿®å¤åçš„é…ç½®
```json
{
  "functions": {
    "dist/main.js": {
      "runtime": "nodejs18.x",
      "maxDuration": 30,
      "memory": 1024
    }
  }
}
```

#### é…ç½®è¯´æ˜
- **ç§»é™¤builds**ï¼šå®Œå…¨åˆ é™¤ `builds` é…ç½®ï¼Œé¿å…å†²çª
- **æŒ‡å®šè¿è¡Œæ—¶**ï¼šåœ¨ `functions` ä¸­æ˜ç¡®æŒ‡å®š `runtime: "nodejs18.x"`
- **æ€§èƒ½é…ç½®**ï¼šä¿ç•™ `maxDuration` å’Œ `memory` è®¾ç½®

#### éªŒè¯æ–¹æ³•
1. é‡æ–°éƒ¨ç½²åˆ°Vercel
2. æ£€æŸ¥éƒ¨ç½²æ—¥å¿—ç¡®è®¤æ— é…ç½®å†²çª
3. æµ‹è¯•APIåŠŸèƒ½æ­£å¸¸

### Vercelå‡½æ•°è¿è¡Œæ—¶ç‰ˆæœ¬æ ¼å¼é”™è¯¯

#### é”™è¯¯æè¿°
```
Error: Function Runtimes must have a valid version, for example `now-php@1.0.0`.
```

#### é”™è¯¯åŸå› 
åœ¨ `functions` é…ç½®ä¸­ä½¿ç”¨äº†ä¸æ­£ç¡®çš„ `runtime` æ ¼å¼ã€‚Vercelè¦æ±‚è¿è¡Œæ—¶å¿…é¡»ä½¿ç”¨ç‰¹å®šçš„ç‰ˆæœ¬æ ¼å¼ï¼Œå¦‚ `now-node@1.0.0`ï¼Œè€Œä¸æ˜¯ç®€å•çš„ `nodejs18.x`ã€‚

#### è§£å†³æ–¹æ¡ˆ
1. **ç§»é™¤runtimeé…ç½®**ï¼šè®©Vercelè‡ªåŠ¨æ£€æµ‹Node.jsè¿è¡Œæ—¶
2. **æˆ–ä½¿ç”¨æ­£ç¡®æ ¼å¼**ï¼šå¦‚æœéœ€è¦æŒ‡å®šï¼Œä½¿ç”¨ `now-node@canary` ç­‰æ­£ç¡®æ ¼å¼

#### ä¿®å¤å‰çš„é…ç½®
```json
{
  "functions": {
    "dist/main.js": {
      "runtime": "nodejs18.x",
      "maxDuration": 30,
      "memory": 1024
    }
  }
}
```

#### ä¿®å¤åçš„é…ç½®
```json
{
  "functions": {
    "dist/main.js": {
      "maxDuration": 30,
      "memory": 1024
    }
  }
}
```

#### é…ç½®è¯´æ˜
- **è‡ªåŠ¨æ£€æµ‹**ï¼šç§»é™¤ `runtime` é…ç½®ï¼Œè®©Vercelæ ¹æ®é¡¹ç›®è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„Node.jsç‰ˆæœ¬
- **ä¿ç•™æ€§èƒ½é…ç½®**ï¼šä¿ç•™ `maxDuration` å’Œ `memory` ç­‰é‡è¦é…ç½®
- **ç®€åŒ–é…ç½®**ï¼šå‡å°‘ä¸å¿…è¦çš„é…ç½®é¡¹ï¼Œé™ä½å‡ºé”™æ¦‚ç‡

#### éªŒè¯æ–¹æ³•
1. é‡æ–°éƒ¨ç½²åˆ°Vercel
2. æ£€æŸ¥éƒ¨ç½²æˆåŠŸä¸”æ— è¿è¡Œæ—¶é”™è¯¯
3. ç¡®è®¤APIåŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

*åˆ›å»ºæ—¶é—´: 2024å¹´12æœˆ*  
*é¡¹ç›®: CORS ä»£ç†æœåŠ¡ (NestJS)*  
*å¹³å°: Vercel*