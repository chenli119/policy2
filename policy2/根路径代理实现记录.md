# 根路径代理实现记录

## 问题描述
用户希望使用 `https://policy-new2.vercel.app/?url=目标URL` 这种根路径方式访问代理服务，但遇到 404 错误。

## 问题分析
1. **路由映射问题**：原有代理控制器在 `/api/proxy` 路径下
2. **Vercel 重写规则问题**：根路径被重写到静态页面 `/public/index.html`，而非 Serverless 函数
3. **缺少根路径处理器**：NestJS 应用中没有处理根路径代理请求的控制器

## 解决方案

### 1. 创建根路径代理控制器
**文件**：`src/root-proxy.controller.ts`

**功能**：
- 使用 `@Controller()` 装饰器（无路径前缀）
- 使用 `@All('/')` 处理所有 HTTP 方法的根路径请求
- 复用现有的 `ProxyService` 进行请求转发

**关键特性**：
- 支持所有 HTTP 方法（GET、POST、PUT、DELETE、PATCH）
- 自动处理 OPTIONS 预检请求
- 统一的错误处理机制

### 2. 注册新控制器
**文件**：`src/app.module.ts`

**修改**：将 `RootProxyController` 添加到 controllers 数组中

### 3. 调整 Vercel 路由规则
**文件**：`vercel.json`

**修改**：将根路径重写规则从静态页面改为 Serverless 函数
```json
// 原来
"destination": "/public/index.html"

// 修改后
"destination": "/api/index"
```

## 使用方式

### 根路径访问
```
https://policy-new2.vercel.app/?url=目标URL
```

### 原路径访问（保持兼容）
```
https://policy-new2.vercel.app/api/proxy?url=目标URL
```

## 测试建议

1. **URL 编码**：建议对 url 参数进行编码
   ```javascript
   const targetUrl = 'http://boxtask.genicsoft.com/api/list/germanyoss/1/5';
   const proxyUrl = `/?url=${encodeURIComponent(targetUrl)}`;
   ```

2. **路径规范化**：避免双斜杠等不规范路径
   ```
   // 推荐
   http://boxtask.genicsoft.com/api/list/germanyoss/1/5
   
   // 避免
   http://boxtask.genicsoft.com//api/list/germanyoss/1/5
   ```

3. **错误诊断**：如果仍返回 404，检查是否为目标服务器的 404，而非代理层的 404

## 技术细节

### CORS 支持
- 自动添加 CORS 头部
- 支持所有主要 HTTP 方法
- 允许常用请求头

### 错误处理
- 网络错误：返回 400 状态码
- 超时错误：返回 500 状态码
- 透传目标服务器的状态码和响应

### 部署流程
1. 构建：`npm run build`
2. 部署到 Vercel（自动触发）
3. 测试根路径和原路径访问

## 兼容性说明
- ✅ 保持原有 `/api/proxy` 路径正常工作
- ✅ 新增根路径 `/` 代理功能
- ✅ 支持所有 HTTP 方法
- ✅ 完整的 CORS 支持

## 安全注意事项
⚠️ 当前配置允许访问任何 URL，生产环境建议：
- 添加域名白名单
- 实现请求频率限制
- 添加身份验证
- 完善日志监控