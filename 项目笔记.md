# CORS 代理服务项目笔记

## 项目概述

### 需求背景
- 前端页面访问第三方API时遇到跨域问题
- 需要一个代理服务来解决CORS限制
- 要求通过 `?url=目标URL` 的方式使用代理
- 需要部署到 Vercel 平台
- **更新**: Vercel项目不支持Serverless Functions，需要改用NestJS

### 解决方案
创建一个基于 NestJS 框架的 TypeScript 应用，作为CORS代理服务部署到Vercel。

## 技术架构

### 核心技术栈
- **框架**: NestJS 10.x
- **语言**: TypeScript 5.x
- **运行环境**: Node.js 18.x
- **部署平台**: Vercel (Node.js 应用)
- **HTTP客户端**: Axios
- **架构模式**: MVC 模式 + 依赖注入

### 项目结构
```
├── src/
│   ├── main.ts                    # 应用入口文件
│   ├── app.module.ts              # 主模块
│   └── proxy/
│       ├── proxy.controller.ts    # 代理控制器
│       └── proxy.service.ts       # 代理服务
├── dist/                          # 构建输出目录
├── public/
│   └── index.html                 # 测试页面
├── package.json                   # 项目配置和依赖
├── tsconfig.json                  # TypeScript配置
├── nest-cli.json                  # NestJS CLI配置
├── vercel.json                    # Vercel部署配置
├── README.md                      # 使用文档
└── 项目笔记.md                   # 项目笔记
```

## 功能实现

### 核心功能
1. **CORS处理**: 自动添加必要的CORS头部
2. **请求转发**: 支持所有HTTP方法(GET, POST, PUT, DELETE, PATCH等)
3. **参数验证**: 验证URL格式和必需参数
4. **错误处理**: 完善的错误处理和响应
5. **内容类型支持**: 支持JSON、文本和二进制数据
6. **TypeScript支持**: 完整的类型安全
7. **依赖注入**: NestJS的IoC容器管理

### 使用方式
```javascript
// 基本用法
fetch('https://your-proxy.vercel.app/api/proxy?url=https://api.example.com/data')

// POST请求示例
fetch('https://your-proxy.vercel.app/api/proxy?url=https://api.example.com/users', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ name: 'John' })
})
```

### 关键特性
- ✅ 支持所有HTTP方法
- ✅ 自动CORS头部处理
- ✅ 请求体转发(POST/PUT)
- ✅ 响应头部转发
- ✅ 多种内容类型支持
- ✅ URL格式验证
- ✅ 错误处理和日志

## 部署配置

### Vercel配置要点
1. **构建命令**: `npm run build`
2. **输出目录**: `dist`
3. **入口文件**: `dist/main.js`
4. **运行时**: 使用 @vercel/node
5. **路由配置**: 将所有请求路由到主应用
6. **CORS头部**: 在Vercel层面也配置CORS
7. **环境变量**: NODE_ENV=production

### 部署步骤
1. 构建项目: `npm run build`
2. 推送代码到GitHub仓库
3. 在Vercel中导入项目
4. Vercel自动执行构建和部署
5. 获得代理服务URL

## 安全考虑

### 当前实现
- 允许访问任何URL(开放代理)
- 基本的URL格式验证
- 错误信息不暴露敏感数据

### 生产环境建议
- 🔒 添加域名白名单限制
- 🔒 实现请求频率限制
- 🔒 添加身份验证机制
- 🔒 添加请求日志和监控
- 🔒 设置请求大小限制

## 测试验证

### 测试页面功能
- 提供可视化测试界面
- 支持实时测试代理功能
- 显示请求结果和错误信息
- 包含使用说明和部署指南

### 测试用例
1. **正常GET请求**: 测试基本代理功能
2. **POST请求**: 测试请求体转发
3. **无效URL**: 测试错误处理
4. **跨域验证**: 确认CORS头部正确设置

## 扩展可能

### 功能增强
- 缓存机制(Redis)
- 请求重试逻辑
- 响应数据转换
- 自定义请求头处理
- WebSocket代理支持

### 监控和分析
- 请求统计和分析
- 性能监控
- 错误率追踪
- 使用量统计

## 项目优势

1. **简单易用**: 一个URL参数即可使用
2. **类型安全**: TypeScript提供完整的类型检查
3. **架构清晰**: NestJS的模块化架构
4. **成本低廉**: Vercel免费额度足够小项目使用
5. **高可用**: 基于Vercel的全球CDN
6. **易维护**: 代码结构清晰，遵循最佳实践
7. **可扩展**: 基于NestJS的依赖注入，易于扩展功能

## 迁移记录

### 从Serverless Functions到NestJS的迁移
- **原因**: Vercel项目不支持Serverless Functions
- **迁移内容**:
  - 将JavaScript改为TypeScript
  - 采用NestJS框架重构
  - 更新依赖和构建配置
  - 修改Vercel部署配置
- **优势**: 更好的代码组织、类型安全、可维护性

## 总结

成功将项目从简单的Node.js函数迁移到基于NestJS的TypeScript应用。新架构提供了更好的代码组织、类型安全和可扩展性，同时保持了原有的功能完整性。项目现在具有更强的企业级开发特性，为后续功能扩展奠定了坚实基础。